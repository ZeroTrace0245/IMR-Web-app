@page "/customers"
@inject IMR_Web_app.Services.IGreenGridService GService
@inject IJSRuntime JS

<PageTitle>Customers</PageTitle>

<h1>Customers</h1>

<div class="card p-3 mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Add Customer</h5>
        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="ExportCustomers">Export CSV</button>
    </div>
    <EditForm Model="newCustomer" OnValidSubmit="AddCustomer">
        <div class="row">
            <div class="col-md-6 mb-2">
                <InputText class="form-control" @bind-Value="newCustomer.Name" placeholder="Name" />
            </div>
            <div class="col-md-6 mb-2">
                <InputText class="form-control" @bind-Value="newCustomer.CustomerType" placeholder="Type (Household/Business)" />
            </div>
            <div class="col-md-6 mb-2">
                <InputText class="form-control" @bind-Value="newCustomer.Phone" placeholder="Phone" />
            </div>
            <div class="col-md-6 mb-2">
                <InputText class="form-control" @bind-Value="newCustomer.Email" placeholder="Email" />
            </div>
            <div class="col-12 mb-2">
                <InputText class="form-control" @bind-Value="newCustomer.Address" placeholder="Address" />
            </div>
        </div>
        <div class="mt-2">
            <button class="btn btn-success">Add</button>
        </div>
    </EditForm>
</div>

@if (customers == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Ref</th>
                <th>Name</th>
                <th>Type</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Address</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in customers)
            {
                <tr>
                    <td>@c.CustomerRef</td>
                    <td>@c.Name</td>
                    <td>@c.CustomerType</td>
                    <td>@c.Phone</td>
                    <td>@c.Email</td>
                    <td>@c.Address</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<IMR_Web_app.Services.Models.CustomerModel>? customers;
    private IMR_Web_app.Services.Models.CustomerModel newCustomer = new();

    protected override async Task OnInitializedAsync()
    {
        customers = await GService.GetCustomersAsync();
    }

    private async Task AddCustomer()
    {
        var added = await GService.AddCustomerAsync(newCustomer);
        newCustomer = new();
        customers = await GService.GetCustomersAsync();
    }

    private async Task ExportCustomers()
    {
        customers ??= await GService.GetCustomersAsync();
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("CustomerRef,Name,CustomerType,Phone,Email,Address");
        foreach (var c in customers)
        {
            sb.AppendLine($"{Escape(c.CustomerRef)},{Escape(c.Name)},{Escape(c.CustomerType)},{Escape(c.Phone)},{Escape(c.Email)},{Escape(c.Address)}");
        }

        var csvBytes = System.Text.Encoding.UTF8.GetBytes(sb.ToString());
        var base64 = System.Convert.ToBase64String(csvBytes);
        await JS.InvokeVoidAsync("downloadFile", "customers.csv", "text/csv", base64);
    }

    private static string Escape(string? value)
    {
        if (string.IsNullOrEmpty(value)) return string.Empty;
        var v = value.Replace("\"", "\"\"");
        return $"\"{v}\"";
    }
}
